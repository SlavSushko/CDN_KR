name: CDN CI/CD (Build → Test → Push → Release)

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

env:
  ORIGIN_IMG: cdn-origin
  EDGE_IMG: cdn-edge
  REDIS_IMG: redis
  PROM_IMG: prom/prometheus
  GRAF_IMG: grafana/grafana

jobs:
  build_and_test:
    name: Build & Test images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build origin image
        run: |
          docker build -t ${ORIGIN_IMG}:local ./origin

      - name: Build edge image
        run: |
          docker build -t ${EDGE_IMG}:local ./edge

      - name: Run image tests
        run: |
          chmod +x ./scripts/tests/*.sh
          ./scripts/tests/test_origin.sh cdn-origin:local
          ./scripts/tests/test_edge.sh cdn-edge:local
          ./scripts/tests/test_redis.sh redis:latest || echo "Redis test warning (non-fatal)"

      - name: Tag images with registry name and SHA
        run: |
          SHORT_SHA=${GITHUB_SHA::8}
          docker tag cdn-origin:local ${{ secrets.DOCKERHUB_USERNAME }}/cdn-origin:${SHORT_SHA}
          docker tag cdn-edge:local ${{ secrets.DOCKERHUB_USERNAME }}/cdn-edge:${SHORT_SHA}
          docker tag cdn-origin:local ${{ secrets.DOCKERHUB_USERNAME }}/cdn-origin:latest
          docker tag cdn-edge:local ${{ secrets.DOCKERHUB_USERNAME }}/cdn-edge:latest

      - name: Push images to Docker Hub
        run: |
          SHORT_SHA=${GITHUB_SHA::8}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/cdn-origin:${SHORT_SHA}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/cdn-edge:${SHORT_SHA}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/cdn-origin:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/cdn-edge:latest

      - name: Upload build metadata
        uses: actions/upload-artifact@v4
        with:
          name: build-info
          path: |
            origin/Dockerfile
            edge/Dockerfile

  delivery:
    name: Generate release stack + upload
    needs: build_and_test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate docker-stack-release.yml
        env:
          DH_USER: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          SHORT_SHA=${GITHUB_SHA::8}
          cp docker-stack.yaml docker-stack-release.yml
          # Replace image placeholders (expects YOUR_DOCKERHUB_USER placeholders or generic names)
          # Replace common image names with concrete ones including tag
          sed -i "s#YOUR_DOCKERHUB_USER/cdn-origin:latest#${DH_USER}/cdn-origin:${SHORT_SHA}#g" docker-stack-release.yml || true
          sed -i "s#YOUR_DOCKERHUB_USER/cdn-edge:latest#${DH_USER}/cdn-edge:${SHORT_SHA}#g" docker-stack-release.yml || true
          # Fallback: replace cdn-origin/cdn-edge placeholders if present
          sed -i "s#slavsushko/cdn-origin:latest#${DH_USER}/cdn-origin:${SHORT_SHA}#g" docker-stack-release.yml || true
          sed -i "s#slavsushko/cdn-edge:latest#${DH_USER}/cdn-edge:${SHORT_SHA}#g" docker-stack-release.yml || true
          # Also write a small manifest
          echo "image_tags:" > release-manifest.yml
          echo "  origin: ${DH_USER}/cdn-origin:${SHORT_SHA}" >> release-manifest.yml
          echo "  edge:   ${DH_USER}/cdn-edge:${SHORT_SHA}" >> release-manifest.yml
          ls -la docker-stack-release.yml release-manifest.yml

      - name: Upload docker-stack-release artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-stack-release
          path: |
            docker-stack-release.yml
            release-manifest.yml

      - name: Create GitHub Release (draft)
        uses: softprops/action-gh-release@v1
        with:
          files: docker-stack-release.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
