name: CI/CD - Build, Push, Deploy, Test

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      REGISTRY: docker.io
      IMAGE_ORIGIN: ${{ secrets.DOCKERHUB_USERNAME }}/cdn-origin
      IMAGE_EDGE: ${{ secrets.DOCKERHUB_USERNAME }}/cdn-edge
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU (if building multi-arch, optional)
        uses: docker/setup-qemu-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build origin image
        run: docker build -t "${{ env.IMAGE_ORIGIN }}:latest" ./origin

      - name: Build edge image
        run: docker build -t "${{ env.IMAGE_EDGE }}:latest" ./edge

      - name: Push images
        run: |
          docker push "${{ env.IMAGE_ORIGIN }}:latest"
          docker push "${{ env.IMAGE_EDGE }}:latest"

      - name: Upload build info artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: build-info
          path: |
            ./origin/Dockerfile
            ./edge/Dockerfile

  deploy-and-test:
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ssh client
        run: sudo apt-get update && sudo apt-get install -y openssh-client jq curl

      - name: Deploy to Swarm manager over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 120000
          script: |
            set -euo pipefail
            cd /path/to/cdn-project || exit 1
            git pull origin main || true
            docker network ls --format '{{.Name}}' | grep -q '^cdn-net$' || docker network create -d overlay --attachable cdn-net
            docker stack rm cdn_stack || true
            sleep 3
            docker stack deploy -c docker-stack.yaml cdn_stack
            sleep 10
            if [ -x ./scripts/prometheus-test.sh ]; then
              ./scripts/prometheus-test.sh || { echo "Prometheus tests failed"; exit 1; }
            else
              echo "Warning: prometheus-test.sh not found on manager"
            fi
            docker stack services cdn_stack

      - name: Run remote swarm-test.sh (optional)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 120000
          script: |
            cd /path/to/cdn-project
            ./scripts/swarm-test.sh

      - name: Upload final report artifact (local path from dev environment)
        uses: actions/upload-artifact@v4
        with:
          name: report
          path: /mnt/data/ПРИМЕР РАБОТЫ ДРУГОЙ ТЕМЫ.pdf
