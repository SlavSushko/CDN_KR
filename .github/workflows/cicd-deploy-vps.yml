name: CI/CD → VPS deploy (Docker Hub + SSH)

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

env:
  DOCKERHUB_REPO_ORIGIN: slavsushko/cdn-origin
  DOCKERHUB_REPO_EDGE: slavsushko/cdn-edge

jobs:

  build_test_and_push:
    name: Build, test and push Docker images
    runs-on: ubuntu-latest

    steps:
      # --- Checkout the repository ---
      - name: Checkout
        uses: actions/checkout@v4

      # --- Enable docker buildx ---
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ==========================================================
      # STEP 1 — Build LOCAL images for testing (origin-img, edge-img)
      # ==========================================================
      - name: Build test images
        run: |
          docker build -t origin-img:latest ./origin
          docker build -t edge-img:latest ./edge

      # ==========================================================
      # STEP 2 — Run tests LOCALLY before pushing to Docker Hub
      # ==========================================================
      - name: Run automated tests
        run: |
          chmod +x scripts/tests/*.sh
          ./scripts/tests/test_origin.sh origin-img:latest
          ./scripts/tests/test_edge.sh edge-img:latest
          ./scripts/tests/test_redis.sh

      # ==========================================================
      # STEP 3 — Login to Docker Hub
      # ==========================================================
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ==========================================================
      # STEP 4 — Build PRODUCTION images (Hub versions)
      # ==========================================================
      - name: Build production images
        run: |
          docker build -t ${DOCKERHUB_REPO_ORIGIN}:latest ./origin
          docker build -t ${DOCKERHUB_REPO_EDGE}:latest ./edge

      # ==========================================================
      # STEP 5 — Push images to Docker Hub
      # ==========================================================
      - name: Push images
        run: |
          # Push latest
          docker push ${DOCKERHUB_REPO_ORIGIN}:latest
          docker push ${DOCKERHUB_REPO_EDGE}:latest
          
          # Tag with commit short sha
          SHORT_SHA=${GITHUB_SHA::8}
          docker tag ${DOCKERHUB_REPO_ORIGIN}:latest ${DOCKERHUB_REPO_ORIGIN}:${SHORT_SHA}
          docker tag ${DOCKERHUB_REPO_EDGE}:latest ${DOCKERHUB_REPO_EDGE}:${SHORT_SHA}
          
          docker push ${DOCKERHUB_REPO_ORIGIN}:${SHORT_SHA}
          docker push ${DOCKERHUB_REPO_EDGE}:${SHORT_SHA}

  # ==============================================================
  # DEPLOY to VPS via SSH
  # ==============================================================

  deploy_to_vps:
    name: Deploy to VPS
    needs: build_test_and_push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy via SSH to VPS
        uses: appleboy/ssh-action@v1.9.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            set -e

            cd ${{ secrets.VPS_DEPLOY_PATH }} || exit 1

            echo "Pulling latest images..."
            docker pull slavsushko/cdn-origin:latest
            docker pull slavsushko/cdn-edge:latest

            echo "Redeploying swarm stack..."
            docker stack rm cdn_stack || true
            sleep 5

            docker stack deploy -c docker-stack.yaml cdn_stack

            echo "Waiting for services..."
            sleep 10

            docker service ls
            docker stack ps cdn_stack
